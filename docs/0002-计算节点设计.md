# 计算节点设计

author: tedious

data: 2023/6/18

version: v0.0.0

## 主逻辑

计算集群的主要目的是为了持续推进用户状态, 为了简化流程, 我做出以下约定:

1. 每间隔20ms为一个Step.
2. 当前Step中收到的全部请求都会在下个Step时计算.
3. 每次Step开始时, 节点根据带计算用户计算出对应的用户集群, 并向用户集群请求本个Step需要处理的请求.
4. 当计算完成时, 将已经离开节点所属区域的用户迁移至对应节点.

## API

计算集群的API主要是用于集群内部用户的转移和数据同步.

### Merge

> 用户迁移(登陆)时计算节点校验用户所在的Slot是否属于该节点, 如果通过则会将用户加入计算节点的用户组.

Put /merge

Request

| 参数名 | 参数类型                       | 说明     | 必填 |
| ------ | ------------------------------ | -------- | ---- |
| users  | HashMap\<u64 /* uid */, User\> | 用户列表 | 是   |

- User

  | 参数名   | 参数类型 | 说明             | 必填 |
  | -------- | -------- | ---------------- | ---- |
  | position | Vector2  | 坐标             | 是   |
  | velocity | u64      | 速度             | 是   |
  | money    | u64      | 钱               | 是   |
  | step     | u64      | 当前用户所在step | 是   |

- Vector2

  | 参数名 | 参数类型 | 说明    | 必填 |
  | ------ | -------- | ------- | ---- |
  | x      | f32      | x轴坐标 | 是   |
  | y      | f32      | y轴坐标 | 是   |

Response

  无返回值

### Query

> 查询计算节点中持有的slot中用户信息.

Get /slots

Request

| 参数名 | 参数类型   | 说明               | 必填 |
| ------ | ---------- | ------------------ | ---- |
| slots  | Vec\<u16\> | 需要查询的slot列表 | 是   |
