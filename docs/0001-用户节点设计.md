# 用户节点设计

author: tedious

data: 2023/6/18

version: 0.0.0

## 主逻辑

用户集群的主要目的是固定住用户连接和记录用户请求, 并尽可能的均匀的将用户分配在整个集群中. 并希望能够尽可能友好的让其他服务快速定位到用户所在服务器.

1. 用户服务器维护一个最新Step以及每个Step下所对应的用户请求.
2. 每当收到一个用户请求, 用户节点会将该请求收入当前待计算Step中. 在间隔时间到达后, 计算集群即可获取该Step进行计算.
3. 计算节点可以根据Step按批获取用户历史请求并恢复用户状态.

## API

用户集群API主要面对用户承接并记录用户请求. 以及响应计算集群的请求, 传递用户的请求.

### Login

Put /login

> 登陆, 若用户不存在则创建用户. position随机, 其余为0.
> 登陆成功后根据用户的坐标调用对应slot的计算节点的merge方法将用户加入计算.

Request

| 参数名 | 参数类型  | 说明     | 必填 |
| ------ | --------- | -------- | ---- |
| uid    | u64       | 用户id   | 是   |

Response

  无返回值

### Logout

> 登出.

Put /logout

Request

| 参数名 | 参数类型  | 说明     | 必填 |
| ------ | --------- | -------- | ---- |
| uid    | u64       | 用户id   | 是   |

Response

  无返回值

### SetVelocity

> 设置用户速度, velocity.len不超过20m/s.

Put /velcoity

Request

| 参数名   | 参数类型  | 说明     | 必填 |
| -------- | --------- | -------- | ---- |
| uid      | u64       | 用户id   | 是   |
| velocity | Vector2   | 速度     | 是   |

- Vector2

  | 参数名 | 参数类型 | 说明    | 必填 |
  | ------ | -------- | ------- | ---- |
  | x      | f32      | x轴坐标 | 是   |
  | y      | f32      | y轴坐标 | 是   |

Response

  无返回值

### AOE

> 用户周围radius半径的圆内的是用户身上的money+m, 自身钱不变, radius不超过50m.

Post /aoe

Request

| 参数名 | 参数类型  | 说明     | 必填 |
| ------ | --------- | -------- | ---- |
| uid    | u64       | 用户id   | 是   |
| radius | f32       | 范围半径 | 是   |
| m      | u64       | 撒钱数量 | 是   |

Response

  无返回值

### Query

> 查询(xmin, ymin) - (xmax, ymax)范围内的所有用户信息.
> 当用户发起查询请求后, 用户节点将坐标转换为相关slot列表, 向计算节点请求相关slot中的用户数据.
> 用户节点收到数据后, 需要对边缘的slot进行一次筛选, 将slot中的未被覆盖的用户去除.

Get /users

Request

| 参数名 | 参数类型  | 说明     | 必填 |
| ------ | --------- | -------- | ---- |
| min    | Vector2   | min坐标  | 是   |
| max    | Vector2   | max坐标  | 是   |

Response

  无返回值

### NextStep

> 计算集群推进step

Get /step

Request

| 参数名 | 参数类型                                 | 说明       | 必填 |
| ------ | ---------------------------------------- | ---------- | ---- |
| users  | HashMap\<u64 /* uid */, u64 /* step */\> | 待计算用户 | 是   |

Response

| 参数名 | 参数类型                                                      | 说明     | 必填 |
| ------ | ------------------------------------------------------------- | -------- | ---- |
| users  | HashMap\<u64 /* uid */, BTreeMap<u64 /* step */, UserAction>> | 用户请求 | 是   |

- UserAction

  | 参数名       | 参数类型    | 说明         | 必填 |
  | ------------ | ----------- | ------------ | ---- |
  | login        | Login       | 登陆请求     | 否   |
  | logout       | Logout      | 登出请求     | 否   |
  | set_velocity | SetVelocity | 设置速度请求 | 否   |
  | aoe          | Vec\<AOE\>  | aoe请求      | 否   |

- Login

  | 参数名 | 参数类型 | 说明   | 必填 |
  | ------ | -------- | ------ | ---- |
  | uid    | u64      | 用户id | 是   |

- Logout

  | 参数名 | 参数类型 | 说明   | 必填 |
  | ------ | -------- | ------ | ---- |
  | uid    | u64      | 用户id | 是   |

- SetVelocity

  | 参数名   | 参数类型  | 说明     | 必填 |
  | -------- | --------- | -------- | ---- |
  | uid      | u64       | 用户id   | 是   |
  | velocity | Vector2   | 速度     | 是   |

- AOE

  | 参数名 | 参数类型  | 说明     | 必填 |
  | ------ | --------- | -------- | ---- |
  | uid    | u64       | 用户id   | 是   |
  | radius | f32       | 范围半径 | 是   |
  | m      | u64       | 撒钱数量 | 是   |
