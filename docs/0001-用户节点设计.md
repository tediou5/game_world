# 用户节点设计

author: tedious

data: 2023/6/18

version: 0.0.0

## 主逻辑

用户集群的主要目的是固定住用户连接和记录用户请求, 并尽可能的均匀的将用户分配在整个集群中. 并希望能够尽可能友好的让其他服务快速定位到用户所在服务器.

1. 用户服务器维护一个最新Step以及每个Step下所对应的用户请求.
2. 每当收到一个用户请求, 用户节点会将该请求收入当前待计算Step中. 在间隔时间到达后, 计算集群即可获取该Step进行计算.
3. 计算节点可以根据Step按批获取用户历史请求并恢复用户状态.

## API

用户集群API主要面对用户承接并记录用户请求. 以及响应计算集群的请求, 传递用户的请求.

### Login

Put /login

> 登陆, 若用户不存在则创建用户. position随机, 其余为0.

Request

| 参数名 | 参数类型  | 说明     | 必填 |
| ------ | --------- | -------- | ---- |
| uid    | u64       | 用户id   | 是   |

Response

  无返回值

### Logout

> 登出.

Put /login

Request

| 参数名 | 参数类型  | 说明     | 必填 |
| ------ | --------- | -------- | ---- |
| uid    | u64       | 用户id   | 是   |

Response

  无返回值

### SetVelocity 

> 设置用户速度, velocity.len不超过20m/s.

Put /velcoity

Request

| 参数名   | 参数类型  | 说明     | 必填 |
| -------- | --------- | -------- | ---- |
| uid      | u64       | 用户id   | 是   |
| velocity | Vector2   | 速度     | 是   |

- Vector2

  | 参数名 | 参数类型 | 说明    | 必填 |
  | ------ | -------- | ------- | ---- |
  | x      | f32      | x轴坐标 | 是   |
  | y      | f32      | y轴坐标 | 是   |

Response

  无返回值

### AOE 

> 用户周围radius半径的圆内的是用户身上的money+m, 自身钱不变, radius不超过50m.

Post /aoe

Request

| 参数名 | 参数类型  | 说明     | 必填 |
| ------ | --------- | -------- | ---- |
| uid    | u64       | 用户id   | 是   |
| radius | f32       | 范围半径 | 是   |
| m      | u64       | 撒钱数量 | 是   |

Response

  无返回值

### Query 

> 查询(xmin, ymin) - (xmax, ymax)范围内的所有用户信息.

get /users

Request

| 参数名 | 参数类型  | 说明     | 必填 |
| ------ | --------- | -------- | ---- |
| min    | Vector2   | min坐标  | 是   |
| max    | Vector2   | max坐标  | 是   |

Response

  无返回值

## 元数据

计算集群和用户集群共同维护以下元数据:

1. 集群成员列表(节点类型, 节点IP)
2. 计算集群slot分配



